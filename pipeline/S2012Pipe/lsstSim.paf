#<?cfg paf policy ?>

# Unified DC3b PT1.2 main ISR-SFM pipeline policy
framework: {
    type: standard
    environment: "$DATAREL_DIR/bin/runOrca/imsim-setupForOrcaUse.sh"
    exec: "$PEX_HARNESS_DIR/bin/launchPipeline.py"
}

execute: {
    nSlices: 1
    barrierDelay: 0.000001
    localLogMode: true
    eventBrokerHost: lsst8.ncsa.uiuc.edu
    shutdownTopic: shutdownMain
    dir: {
        shortName: Main
        # Following directory info is OVERLAID
        # by imsim-orca.paf:platform defn
        defaultRoot: .
        runDirPattern: "../../%(runid)s/%(shortname)s"
        work: work
        input: input
        output: output
        update: update
        scratch: scratch
    }

    appStage: {
        name: getAJob
        parallelClass: lsst.ctrl.sched.pipeline.GetAJobParallelProcessing
        eventTopic: None
        stagePolicy: {
            pipelineEvent: CcdJob
        }
    }

    appStage: {
        name: pipeTask
        parallelClass: lsst.datarel.pipeTaskStage.PipeTaskStageParallel
        eventTopic: None
        stagePolicy: {
            parameters: {
		taskName: processCcd
                taskClass: ProcessCcdTask
                taskModule: lsst.pipe.tasks.processCcd
		dataIdNames: "visit" "raft" "sensor"
                cmdTemplate: "lsstSim %(input)s --doraise --output %(output)s --id visit=%(visit)s raft=%(raft)s sensor=%(sensor)s"
            }
        }
    }

    appStage: {
        name: jobDone
        parallelClass: lsst.ctrl.sched.pipeline.JobDoneParallelProcessing
        eventTopic: None
        stagePolicy: {
            pipelineEvent:  CcdJob
            datasets.dataReadyEvent:  CalexpAvailable
        }
    }
    failureStage: {
        name: failure
        parallelClass: lsst.ctrl.sched.pipeline.JobDoneParallelProcessing
        eventTopic: None
        stagePolicy: {
            pipelineEvent:  CcdJob
            datasets.dataReadyEvent:  CalexpAvailable
            jobSuccess: false
        }
    }
}
