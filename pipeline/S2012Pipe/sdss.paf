#<?cfg paf policy ?>

# Unified DC3b PT1.2 main ISR-SFM pipeline policy
framework: {
    type: standard
    environment: "$DATAREL_DIR/bin/runOrca/imsim-setupForOrcaUse.sh"
    exec: "$PEX_HARNESS_DIR/bin/launchPipeline.py"
}

execute: {
    nSlices: 1
    barrierDelay: 0.000001
    localLogMode: true
    eventBrokerHost: lsst8.ncsa.uiuc.edu
    shutdownTopic: shutdownMain
    dir: {
        shortName: Main
        # Following directory info is OVERLAID
        # by imsim-orca.paf:platform defn
        defaultRoot: .
        runDirPattern: "../../%(runid)s/%(shortname)s"
        work: work
        input: input
        output: output
        update: update
        scratch: scratch
    }

    appStage: {
        name: getAJob
        parallelClass: lsst.ctrl.sched.pipeline.GetAJobParallelProcessing
        eventTopic: None
        stagePolicy: {
            pipelineEvent: CcdJob
        }
    }

    appStage: {
        name: pipeTask
        parallelClass: lsst.datarel.pipeTaskStage.PipeTaskStageParallel
        eventTopic: None
        stagePolicy: {
            parameters: {
		taskName: processCcd
                taskClass: ProcessCcdSdssTask
                taskModule: lsst.pipe.tasks.processCcdSdss
		dataIdNames: "run" "filter" "camcol" "field"
                cmdTemplate: "sdss %(input)s --doraise --configfile=%(MEAS_EXTENSIONS_MULTISHAPELET_DIR)s/config/multiShapelet.py --output %(output)s --id run=%(run)s filter=%(filter)s camcol=%(camcol)s field=%(field)s"
		perFilterCommand: {
		    u: " --configfile %(DATAREL_DIR)s/pipeline/S2012Pipe/sdssPsf.py"
		    z: " --configfile %(DATAREL_DIR)s/pipeline/S2012Pipe/sdssPsf.py"
                }
            }
        }
    }

    appStage: {
        name: jobDone
        parallelClass: lsst.ctrl.sched.pipeline.JobDoneParallelProcessing
        eventTopic: None
        stagePolicy: {
            pipelineEvent:  CcdJob
            datasets.dataReadyEvent:  CalexpAvailable
        }
    }
    failureStage: {
        name: failure
        parallelClass: lsst.ctrl.sched.pipeline.JobDoneParallelProcessing
        eventTopic: None
        stagePolicy: {
            pipelineEvent:  CcdJob
            datasets.dataReadyEvent:  CalexpAvailable
            jobSuccess: false
        }
    }
}
